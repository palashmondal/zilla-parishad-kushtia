<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ - ‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡¶∞‡¶ø‡¶∑‡¶¶, ‡¶ï‡ßÅ‡¶∑‡ßç‡¶ü‡¶ø‡¶Ø‡¶º‡¶æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <!-- Leaflet ‚Äî lightweight OSM map for project location -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="ZPK Admin" />
    <link rel="manifest" href="/favicon/site.webmanifest" />

    <style>
        * { font-family: 'Hind Siliguri', sans-serif; }

        .ts-wrapper { font-family: 'Hind Siliguri', sans-serif; }
        .ts-control {
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            padding: 0.5rem 1rem !important;
            font-size: 1rem !important;
            font-weight: 400 !important;
            line-height: 1.5rem !important;
            color: #1f2937 !important;
            background: #ffffff !important;
            box-shadow: none !important;
            cursor: pointer !important;
            transition: border-color 0.2s, box-shadow 0.2s !important;
            min-height: unset !important;
        }
        .ts-wrapper.focus .ts-control {
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 2px rgba(245,158,11,0.3) !important;
        }
        .ts-control:hover { border-color: #fcd34d !important; }
        .ts-dropdown {
            border: 2px solid #f59e0b !important;
            border-radius: 0.75rem !important;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12) !important;
            font-family: 'Hind Siliguri', sans-serif !important;
            font-size: 0.95rem !important;
            overflow: hidden !important;
            margin-top: 4px !important;
        }
        .ts-dropdown .option {
            padding: 0.6rem 1rem !important;
            font-weight: 500 !important;
            color: #1f2937 !important;
            cursor: pointer !important;
            transition: background 0.15s !important;
        }
        .ts-dropdown .option:hover,
        .ts-dropdown .option.active { background: #fef3c7 !important; color: #92400e !important; }
        .ts-dropdown .option.selected { background: #fde68a !important; color: #92400e !important; font-weight: 700 !important; }

        .table-row { transition: all 0.2s ease; }
        .table-row:hover { background: #fffbeb; }

        .sortable-th { cursor: pointer; user-select: none; }
        .sortable-th:hover { background: #e5e7eb; }
        .sortable-th .sort-icon { opacity: 0.35; transition: all 0.2s ease; display: inline-block; vertical-align: middle; }
        .sortable-th.active .sort-icon { opacity: 1; color: #b45309; }

        /* Currency display ‚Äî amber theme */
        .currency-amount {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-variant-numeric: tabular-nums;
            background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid #fcd34d;
            box-shadow: 0 2px 4px rgba(245,158,11,0.1);
            transition: all 0.2s ease;
        }
        .currency-amount:hover { box-shadow: 0 4px 8px rgba(245,158,11,0.2); transform: translateY(-1px); border-color: #f59e0b; }
        .currency-symbol { font-size: 1rem; font-weight: 700; color: #b45309; }

        .action-btn { transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.12); }
        .action-btn:active { transform: translateY(0); }

        /* Detail modal animation */
        .detail-backdrop {
            opacity: 0; pointer-events: none;
            background: rgba(180,83,9,0.08);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            transition: opacity 0.3s cubic-bezier(.4,0,.2,1);
        }
        .detail-backdrop.open { opacity: 1; pointer-events: auto; }
        .detail-card { transform: translateY(24px) scale(0.97); opacity: 0; transition: transform 0.32s cubic-bezier(.34,1.56,.64,1), opacity 0.28s ease; }
        .detail-backdrop.open .detail-card { transform: translateY(0) scale(1); opacity: 1; }

        /* Form modal backdrop */
        #form-modal {
            background: rgba(180,83,9,0.08);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
        }

        /* Progress bar */
        .progress-bar-bg { background: #e5e7eb; border-radius: 999px; height: 8px; }
        .progress-bar-fill { height: 8px; border-radius: 999px; transition: width 0.6s ease; }

        /* Status badges - Enhanced for prominence */
        .badge-completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #10b981;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
        .badge-delayed {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #ef4444;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }
        .badge-ongoing {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 2px solid #3b82f6;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        .badge-pending {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #374151;
            border: 2px solid #9ca3af;
            box-shadow: 0 2px 4px rgba(156, 163, 175, 0.2);
        }

        /* Modal internals - matching public page */
        .modal-avatar {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
        }
        .modal-amount-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 60%, #fef9c3 100%);
            border: 1px solid #fbbf24;
        }
        .modal-close-btn {
            background: linear-gradient(135deg, #b45309 0%, #92400e 100%);
            transition: filter 0.2s, transform 0.1s;
        }
        .modal-close-btn:hover { filter: brightness(1.12); }
        .modal-close-btn:active { transform: scale(0.97); }

        /* Modal progress bar */
        .progress-bar-track {
            background: #e5e7eb; border-radius: 8px; height: 16px; overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-bar-fill {
            height: 100%; border-radius: 8px; transition: width 0.6s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .progress-bar-green {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }
        .progress-bar-orange {
            background: linear-gradient(90deg, #f97316, #ea580c);
        }

        /* Progress log timeline */
        .progress-log-row {
            display: flex; align-items: flex-start; gap: 12px;
            background: #fffbeb; border: 1px solid #fde68a;
            border-radius: 14px; padding: 11px 14px;
            transition: background 0.15s;
        }
        .progress-log-row:hover { background: #fef3c7; }
        .plog-dot {
            width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 4px;
        }
        .plog-dot-normal   { background: #b45309; }
        .plog-dot-delayed  { background: #ef4444; }
        .plog-dot-complete { background: #16a34a; }
        .plog-pct {
            font-size: 12px; font-weight: 800; color: #b45309;
            background: #fef3c7; border-radius: 6px;
            padding: 1px 7px; flex-shrink: 0; margin-top: 1px;
        }
        .plog-date {
            font-size: 11px; color: #92400e; font-weight: 600; flex-shrink: 0; margin-top: 2px;
        }
        .plog-status {
            font-size: 13px; font-weight: 700; color: #78350f; line-height: 1.3;
        }
        .plog-note {
            font-size: 12px; color: #92400e; margin-top: 3px; line-height: 1.4;
        }
        .plog-flag {
            font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: 5px; flex-shrink: 0; margin-top: 2px;
        }
        .plog-flag-delayed  { background: #fee2e2; color: #991b1b; }
        .plog-flag-complete { background: #dcfce7; color: #166534; }

        /* ‚îÄ‚îÄ Image Lightbox ‚Äî frosted glass card ‚îÄ‚îÄ */
        #adm-lightbox {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            padding: 24px;
            background: rgba(8, 5, 2, 0.6);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            opacity: 0; pointer-events: none;
            transition: opacity 0.28s cubic-bezier(.4,0,.2,1);
        }
        #adm-lightbox.lb-open { opacity: 1; pointer-events: auto; }

        .adm-lb-card {
            position: relative;
            display: flex; flex-direction: column;
            width: 100%; max-width: 960px;
            max-height: calc(100vh - 48px);
            background: rgba(20, 12, 4, 0.55);
            backdrop-filter: blur(28px) saturate(1.6) brightness(0.75);
            -webkit-backdrop-filter: blur(28px) saturate(1.6) brightness(0.75);
            border-radius: 22px;
            border: 1px solid rgba(251,191,36,0.22);
            box-shadow:
                0 32px 80px rgba(0,0,0,0.7),
                0 0 0 1px rgba(255,255,255,0.04) inset,
                0 1px 0 rgba(251,191,36,0.15) inset;
            overflow: hidden;
            transform: scale(0.9) translateY(24px);
            opacity: 0;
            transition: transform 0.36s cubic-bezier(.34,1.4,.64,1),
                        opacity   0.28s cubic-bezier(.4,0,.2,1);
        }
        #adm-lightbox.lb-open .adm-lb-card {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* topbar */
        .adm-lb-topbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px 10px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.38), transparent);
            flex-shrink: 0; gap: 10px;
        }
        .adm-lb-zoom-group {
            display: flex; align-items: center; gap: 4px;
        }
        .adm-lb-zoom-btn {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            border: 1.5px solid rgba(255,255,255,0.13);
            color: rgba(255,255,255,0.8); cursor: pointer;
            transition: background 0.18s;
        }
        .adm-lb-zoom-btn:hover { background: rgba(180,83,9,0.6); border-color: #d97706; color: #fff; }
        .adm-lb-zoom-btn svg { width: 15px; height: 15px; }
        .adm-lb-zoom-level {
            font-size: 11px; font-weight: 700; font-family: monospace;
            color: rgba(255,255,255,0.6); min-width: 38px; text-align: center;
        }
        .adm-lb-reset-btn {
            font-size: 11px; font-weight: 700;
            padding: 4px 10px; border-radius: 6px;
            background: rgba(255,255,255,0.07);
            border: 1.5px solid rgba(255,255,255,0.13);
            color: rgba(255,255,255,0.7); cursor: pointer;
            transition: background 0.18s;
        }
        .adm-lb-reset-btn:hover { background: rgba(255,255,255,0.15); }
        .adm-lb-counter {
            font-size: 12px; font-weight: 700;
            color: rgba(255,255,255,0.55); letter-spacing: 0.05em;
        }
        .adm-lb-close {
            width: 34px; height: 34px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.08);
            border: 1.5px solid rgba(255,255,255,0.15);
            color: #fff; cursor: pointer;
            transition: background 0.2s, transform 0.18s;
        }
        .adm-lb-close:hover { background: rgba(239,68,68,0.6); transform: scale(1.1) rotate(90deg); }
        .adm-lb-close svg { width: 16px; height: 16px; }

        /* stage */
        .adm-lb-stage {
            flex: 1; min-height: 0;
            display: flex; align-items: center; justify-content: center;
            padding: 4px 52px;
            position: relative; overflow: hidden;
        }
        .adm-lb-img-wrap {
            max-width: 100%; max-height: 100%;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        #adm-lb-img {
            max-width: 100%;
            max-height: calc(100vh - 280px);
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.55);
            display: block;
            transition: transform 0.2s ease;
            cursor: grab;
        }
        #adm-lb-img:active { cursor: grabbing; }

        /* arrows */
        .adm-lb-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.07);
            border: 1.5px solid rgba(255,255,255,0.13);
            border-radius: 50%; color: #fff; cursor: pointer; z-index: 3;
            transition: background 0.18s, transform 0.18s, border-color 0.18s;
        }
        .adm-lb-arrow:hover { background: rgba(180,83,9,0.75); border-color: #d97706; transform: translateY(-50%) scale(1.12); }
        .adm-lb-arrow:active { transform: translateY(-50%) scale(0.94); }
        .adm-lb-arrow svg { width: 18px; height: 18px; }
        .adm-lb-prev { left: 10px; }
        .adm-lb-next { right: 10px; }
        .adm-lb-arrow.lb-hidden { opacity: 0; pointer-events: none; }

        /* caption */
        .adm-lb-caption {
            padding: 8px 18px 6px;
            text-align: center; flex-shrink: 0;
            font-size: 12px; color: rgba(255,255,255,0.65);
            min-height: 32px;
        }
        .adm-lb-type-pill {
            display: inline-block;
            font-size: 10px; font-weight: 800; letter-spacing: 0.06em;
            padding: 2px 10px; border-radius: 9999px;
            background: rgba(251,191,36,0.18);
            border: 1px solid rgba(251,191,36,0.3);
            color: #fbbf24; margin-bottom: 4px;
        }

        /* thumbnail strip */
        .adm-lb-strip-wrap {
            padding: 8px 14px 14px;
            display: flex; justify-content: center; flex-shrink: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.32), transparent);
        }
        .adm-lb-strip {
            display: flex; gap: 6px;
            overflow-x: auto; scroll-behavior: smooth;
            max-width: 100%;
        }
        .adm-lb-strip::-webkit-scrollbar { height: 3px; }
        .adm-lb-strip::-webkit-scrollbar-track { background: transparent; }
        .adm-lb-strip::-webkit-scrollbar-thumb { background: rgba(251,191,36,0.4); border-radius: 99px; }
        .adm-lb-thumb {
            flex-shrink: 0; width: 72px; height: 54px;
            border-radius: 8px; overflow: hidden;
            border: 2px solid rgba(255,255,255,0.15);
            cursor: pointer; opacity: 0.55;
            transition: opacity 0.18s, border-color 0.18s, transform 0.18s;
        }
        .adm-lb-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .adm-lb-thumb:hover { opacity: 0.85; transform: scale(1.06); }
        .adm-lb-thumb.active {
            border-color: #fbbf24; opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 0 0 2px rgba(251,191,36,0.35);
        }

        /* Photo Gallery */
        .photo-tab {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 5px 11px; border-radius: 9999px;
            font-size: 11px; font-weight: 700; cursor: pointer;
            border: 1.5px solid #fcd34d; background: #fff; color: #92400e;
            transition: background 0.15s, color 0.15s;
        }
        .photo-tab.active { background: #b45309; color: #fff; border-color: #b45309; }
        .photo-tab:hover:not(.active) { background: #fef3c7; }

        .photo-thumb {
            position: relative; aspect-ratio: 4/3; overflow: hidden;
            border-radius: 0.75rem; cursor: pointer;
            border: 2px solid #fcd34d;
            transition: transform 0.18s, box-shadow 0.18s;
        }
        .photo-thumb:hover { transform: scale(1.04); box-shadow: 0 6px 18px rgba(180,83,9,0.22); }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .photo-thumb .photo-type-badge {
            position: absolute; bottom: 5px; left: 5px;
            font-size: 9px; font-weight: 800; padding: 2px 7px;
            border-radius: 9999px; letter-spacing: 0.03em;
        }
        .ptype-before  { background: #fef3c7; color: #92400e; }
        .ptype-during  { background: #dbeafe; color: #1e40af; }
        .ptype-after   { background: #d1fae5; color: #065f46; }
        .ptype-general { background: #f3e8ff; color: #6b21a8; }

        /* ‚îÄ‚îÄ Photo upload section (form modal) ‚îÄ‚îÄ */
        .photo-upload-zone {
            border: 2px dashed #fcd34d; border-radius: 1rem;
            background: #fffbeb; padding: 2rem 1.5rem;
            text-align: center; cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            position: relative;
        }
        .photo-upload-zone:hover, .photo-upload-zone.drag-over {
            border-color: #b45309; background: #fef3c7;
        }
        .photo-upload-zone input[type="file"] {
            position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
        }
        .upload-preview-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem; margin-top: 0.75rem;
        }
        .upload-preview-item {
            position: relative; aspect-ratio: 4/3; border-radius: 0.6rem; overflow: hidden;
            border: 2px solid #fcd34d; background: #fef3c7;
        }
        .upload-preview-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .upload-preview-item .preview-remove {
            position: absolute; top: 3px; right: 3px;
            width: 20px; height: 20px; border-radius: 50%;
            background: rgba(220,38,38,0.9); color: #fff;
            border: none; cursor: pointer; font-size: 12px; line-height: 1;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.15s;
        }
        .upload-preview-item .preview-remove:hover { background: #dc2626; }
        .upload-preview-item .preview-type-badge {
            position: absolute; bottom: 3px; left: 3px;
            font-size: 8px; font-weight: 800; padding: 1px 5px;
            border-radius: 9999px; background: rgba(0,0,0,0.55); color: #fff;
        }
        /* Delete button on existing photos in detail modal */
        .photo-thumb .photo-delete-btn {
            position: absolute; top: 4px; right: 4px;
            width: 22px; height: 22px; border-radius: 50%;
            background: rgba(220,38,38,0.85); color: #fff;
            border: none; cursor: pointer; font-size: 11px;
            display: none; align-items: center; justify-content: center;
            transition: background 0.15s, opacity 0.15s;
            z-index: 2;
        }
        .photo-thumb:hover .photo-delete-btn { display: flex; }
        .photo-delete-btn:hover { background: #dc2626 !important; }

        /* Project location map */
        #m-map-section {
            margin-top: 1.5rem; padding-top: 1.25rem;
            border-top: 1px solid #fcd34d;
        }
        #m-map-container {
            width: 100%; height: 260px;
            border-radius: 1.2rem; overflow: hidden;
            border: 2px solid #fcd34d;
            box-shadow: 0 6px 24px rgba(180,83,9,0.12);
            position: relative;
            transition: box-shadow 0.25s;
        }
        #m-map-container:hover {
            box-shadow: 0 8px 30px rgba(180,83,9,0.2);
        }
        #m-map-container .leaflet-control-attribution {
            font-size: 9px; background: rgba(255,255,255,0.75);
        }
        .map-coord-pill {
            display: inline-flex; align-items: center; gap: 6px;
            margin-top: 8px; padding: 4px 12px;
            background: #fef3c7; border: 1px solid #fcd34d;
            border-radius: 9999px; font-size: 11px; font-weight: 600;
            color: #92400e; font-family: 'Courier New', monospace;
        }
        .map-coord-pill svg { width: 12px; height: 12px; color: #b45309; }
        .map-open-link {
            display: inline-flex; align-items: center; gap: 5px;
            margin-top: 8px; margin-left: 8px; padding: 4px 12px;
            background: #fff; border: 1px solid #fcd34d;
            border-radius: 9999px; font-size: 11px; font-weight: 700;
            color: #b45309; text-decoration: none;
            transition: background 0.15s, color 0.15s;
        }
        .map-open-link:hover { background: #b45309; color: #fff; border-color: #b45309; }
        .map-open-link svg { width: 12px; height: 12px; }

        .zpk-marker-pin {
            width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div id="header-container"></div>

    <!-- Navigation -->
    <div id="menu-container"></div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Success/Error Messages -->
        <div id="success-message" class="hidden mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
            <p id="success-text"></p>
        </div>
        <div id="error-message" class="hidden mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
            <p id="error-text"></p>
        </div>

        <!-- Header Section -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
                    <p class="text-gray-600">‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡¶∞‡¶ø‡¶∑‡¶¶‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶â‡¶®‡ßç‡¶®‡¶Ø‡¶º‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</p>
                </div>
                <button data-role="admin" onclick="openAddModal()" class="flex items-center gap-2 px-6 py-3 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>

            <!-- Search and Filters -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶®</label>
                    <input type="text" id="search-input" placeholder="‡¶®‡¶æ‡¶Æ, ‡¶Ü‡¶á‡¶°‡¶ø, ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡¶Ö‡¶∞‡ßç‡¶•‡¶¨‡¶õ‡¶∞</label>
                    <select id="year-filter" class="w-full border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white hover:border-amber-400 transition-all font-medium text-sm">
                        <option value="">‡¶∏‡¶ï‡¶≤ ‡¶Ö‡¶∞‡ßç‡¶•‡¶¨‡¶õ‡¶∞</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</label>
                    <select id="method-filter" class="w-full border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white hover:border-amber-400 transition-all font-medium text-sm">
                        <option value="">‡¶∏‡¶ï‡¶≤ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</option>
                        <option value="‡¶ü‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞">‡¶ü‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞</option>
                        <option value="‡¶∏‡¶ø‡¶™‡¶ø‡¶™‡¶ø‡¶∏‡¶ø">‡¶∏‡¶ø‡¶™‡¶ø‡¶™‡¶ø‡¶∏‡¶ø</option>
                        <option value="‡¶Ü‡¶∞‡¶è‡¶´‡¶ï‡¶ø‡¶â">‡¶Ü‡¶∞‡¶è‡¶´‡¶ï‡¶ø‡¶â</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</label>
                    <select id="status-filter" class="w-full border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white hover:border-amber-400 transition-all font-medium text-sm">
                        <option value="">‡¶∏‡¶ï‡¶≤ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</option>
                        <option value="completed">‚úÖ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</option>
                        <option value="delayed">‚ö†Ô∏è ‡¶¨‡¶ø‡¶≤‡¶Æ‡ßç‡¶¨‡¶ø‡¶§</option>
                        <option value="ongoing">üîÑ ‡¶ö‡¶≤‡¶Æ‡¶æ‡¶®</option>
                        <option value="pending">‚è≥ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Records List -->
        <div class="space-y-4">
            <div id="loading" class="hidden p-12 text-center bg-white rounded-xl">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-amber-600"></div>
                <p class="mt-4 text-lg text-gray-600 font-medium">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
            </div>

            <div id="table-container" class="hidden bg-white rounded-xl shadow-md overflow-hidden">
                <table class="w-full table-fixed">
                    <thead class="bg-gray-50 border-b-2 border-gray-200">
                        <tr>
                            <th onclick="sortTable('project_name')" data-col="project_name" class="sortable-th w-[26%] px-4 py-2.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ <svg class="sort-icon w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
                            </th>
                            <th onclick="sortTable('upazila')" data-col="upazila" class="sortable-th w-[10%] px-4 py-2.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ <svg class="sort-icon w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
                            </th>
                            <th onclick="sortTable('fund_type')" data-col="fund_type" class="sortable-th w-[16%] px-4 py-2.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                ‡¶§‡¶π‡¶¨‡¶ø‡¶≤ ‡¶â‡ßé‡¶∏ <svg class="sort-icon w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
                            </th>
                            <th onclick="sortTable('financial_year')" data-col="financial_year" class="sortable-th w-[8%] px-4 py-2.5 text-center text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                ‡¶Ö‡¶∞‡ßç‡¶•‡¶¨‡¶õ‡¶∞ <svg class="sort-icon w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
                            </th>
                            <th onclick="sortTable('progress_percentage')" data-col="progress_percentage" class="sortable-th w-[11%] px-4 py-2.5 text-center text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø <svg class="sort-icon w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
                            </th>
                            <th class="w-[9%] px-4 py-2.5 text-center text-xs font-semibold text-gray-600 uppercase tracking-wide">‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th>
                            <th onclick="sortTable('allocation_amount')" data-col="allocation_amount" class="sortable-th w-[13%] px-4 py-2.5 text-right text-xs font-semibold text-amber-600 uppercase tracking-wide">
                                üí∞ ‡¶¨‡¶∞‡¶æ‡¶¶‡ßç‡¶¶ <svg class="sort-icon w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
                            </th>
                            <th class="w-[5%] px-4 py-2.5 text-center text-xs font-semibold text-gray-600 uppercase tracking-wide">‡¶ï‡¶æ‡¶ú</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-100"></tbody>
                </table>
            </div>

            <div id="empty-state" class="hidden p-12 text-center bg-white rounded-xl">
                <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <h3 class="mt-4 text-lg font-semibold text-gray-900">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</h3>
                <p class="mt-2 text-sm text-gray-500">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            </div>

            <div id="pagination-container" class="flex justify-center py-6"></div>
        </div>
    </main>

    <!-- ‚îÄ‚îÄ Detail Modal ‚îÄ‚îÄ -->
    <div id="detail-modal" class="detail-backdrop fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="detail-card bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl p-8 relative max-h-[90vh] overflow-y-auto">
            <div class="flex items-start justify-between mb-6">
                <div class="flex items-center gap-4 flex-1">
                    <div class="modal-avatar w-20 h-20 rounded-2xl flex items-center justify-center text-[#b45309] flex-shrink-0">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h2 id="dm-name" class="text-2xl font-extrabold text-slate-900 leading-tight"></h2>
                    </div>
                </div>
                <button onclick="closeDetailModal()" class="text-slate-300 hover:text-[#d97706] transition-colors p-2 flex-shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <div class="space-y-5 border-t border-[#fcd34d] pt-6">

                <!-- Row 1: ID ¬∑ Year ¬∑ Upazila -->
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶Ü‡¶á‡¶°‡¶ø</p>
                        <p id="dm-id" class="font-semibold text-slate-800 text-base font-mono"></p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶Ö‡¶∞‡ßç‡¶•‡¶¨‡¶õ‡¶∞</p>
                        <p id="dm-year" class="font-semibold text-slate-800 text-base"></p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</p>
                        <p id="dm-upazila" class="font-semibold text-slate-800 text-base"></p>
                    </div>
                </div>

                <!-- Row 2: Fund Type ¬∑ Status -->
                <div class="grid grid-cols-2 gap-4 items-start">
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶§‡¶π‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£</p>
                        <p id="dm-fund-type" class="font-semibold text-slate-800 text-base"></p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</p>
                        <p id="dm-status" class="font-semibold text-slate-700 text-base"></p>
                    </div>
                </div>

                <!-- Row 2.5: Approval Date ¬∑ Memo Number -->
                <div class="grid grid-cols-2 gap-4 items-start">
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</p>
                        <p id="dm-approval-date" class="font-bold text-[#b45309] text-lg"></p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡¶ï ‡¶®‡¶Ç‡¶¨‡¶∞</p>
                        <p id="dm-memo-number" class="font-bold text-[#b45309] text-base font-mono"></p>
                    </div>
                </div>

                <!-- Row 2.7: Project Type ¬∑ Implementation ¬∑ Status -->
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶ß‡¶∞‡¶®</p>
                        <p id="dm-quick-type" class="font-semibold text-slate-800 text-base"></p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</p>
                        <p id="dm-quick-method" class="font-semibold text-slate-800 text-base"></p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</p>
                        <p id="dm-quick-status" class="font-semibold text-slate-700 text-base"></p>
                    </div>
                </div>

                <!-- Row 3: Start ¬∑ Expected End ¬∑ Actual End -->
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</p>
                        <p id="dm-start" class="font-semibold text-slate-800 text-base"></p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶∏‡¶Æ‡¶æ‡¶™‡ßç‡¶§‡¶ø</p>
                        <p id="dm-expected-end" class="font-semibold text-slate-800 text-base"></p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶∏‡¶Æ‡¶æ‡¶™‡ßç‡¶§‡¶ø</p>
                        <p id="dm-actual-end" class="font-semibold text-slate-800 text-base"></p>
                    </div>
                </div>

                <!-- Remarks -->
                <div id="dm-remarks-wrap" class="hidden">
                    <p class="text-xs font-bold text-[#d4a017] uppercase tracking-wider mb-2">‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</p>
                    <p id="dm-remarks" class="font-medium text-slate-600 text-base leading-relaxed"></p>
                </div>

                <!-- Amount box with progress bars -->
                <div class="modal-amount-box p-6 rounded-2xl">
                    <div class="flex justify-between items-start mb-5">
                        <div>
                            <p class="text-xs font-bold text-[#92400e] uppercase tracking-wider mb-2">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶∞‡¶æ‡¶¶‡ßç‡¶¶</p>
                            <p id="dm-allocation" class="text-3xl font-black text-[#b45309] tracking-tight"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-bold text-[#92400e] uppercase tracking-wider mb-2">‡¶õ‡¶æ‡¶°‡¶º‡¶ï‡ßÉ‡¶§ ‡¶Ö‡¶∞‡ßç‡¶•</p>
                            <p id="dm-released" class="text-2xl font-black text-[#d97706] tracking-tight"></p>
                        </div>
                    </div>
                    <!-- Progress bar: project completion -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-bold text-green-700 uppercase tracking-wider">‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø</span>
                            <span id="dm-progress-pct" class="text-sm font-bold text-green-700 px-2.5 py-1 bg-green-50 rounded"></span>
                        </div>
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill progress-bar-green" id="dm-progress-bar" style="width:0%"></div>
                        </div>
                    </div>
                    <!-- Progress bar: fund release -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-bold text-orange-700 uppercase tracking-wider">‡¶§‡¶π‡¶¨‡¶ø‡¶≤ ‡¶õ‡¶æ‡¶°‡¶º‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞</span>
                            <span id="dm-fund-release-pct" class="text-sm font-bold text-orange-700 px-2.5 py-1 bg-orange-50 rounded"></span>
                        </div>
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill progress-bar-orange" id="dm-fund-release-bar" style="width:0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Log Timeline -->
            <div id="dm-progress-log-section" class="hidden mt-6 pt-5 border-t border-[#fcd34d]">
                <p class="text-sm font-bold text-[#d4a017] uppercase tracking-wider mb-4">‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</p>
                <div id="dm-progress-log-list" class="space-y-2"></div>
            </div>

            <!-- Location Map -->
            <div id="dm-map-section" class="hidden mt-6 pt-5 border-t border-[#fcd34d]">
                <p class="text-sm font-bold text-[#d4a017] uppercase tracking-wider mb-4">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®</p>
                <div id="m-map-container"></div>
                <div class="flex items-center flex-wrap gap-2 mt-2">
                    <span class="map-coord-pill">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span id="dm-coord-text"></span>
                    </span>
                    <button onclick="editProjectLocation()" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-amber-600 to-amber-700 text-white text-sm font-semibold rounded-lg hover:from-amber-700 hover:to-amber-800 transition-all shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        ‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ
                    </button>
                    <button onclick="openFullMap()" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white text-sm font-semibold rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                        </svg>
                        ‡¶¨‡¶°‡¶º ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                    </button>
                    <a id="dm-map-link" href="#" target="_blank" rel="noopener" class="map-open-link">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                    </a>
                </div>
            </div>

            <!-- Photo Gallery -->
            <div id="dm-photos-section" class="hidden mt-6 pt-5 border-t border-[#fcd34d]">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm font-bold text-[#d4a017] uppercase tracking-wider">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø</p>
                    <button onclick="openQuickUpload()" type="button"
                        class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-bold
                               bg-gradient-to-r from-[#b45309] to-[#d97706] text-white
                               shadow hover:shadow-md transition-all active:scale-95">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <path d="M12 4v16m8-8H4"/>
                        </svg>
                        ‡¶õ‡¶¨‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
                <div id="dm-photos-tabs" class="hidden flex gap-2 flex-wrap mb-3"></div>
                <div id="dm-photos-grid" class="grid grid-cols-3 gap-2"></div>

                <!-- No photos message -->
               
            </div>

            <!-- Quick photo upload panel (inside detail modal) -->
            <div id="quick-upload-panel" class="hidden mt-4 pt-4 border-t border-[#fcd34d]">
                <p class="text-[11px] font-bold text-[#d4a017] uppercase tracking-wider mb-3">‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                <div class="photo-upload-zone" id="quick-drop-zone" style="padding:1rem;">
                    <input type="file" id="quick-file-input" accept="image/jpeg,image/png,image/webp" multiple>
                    <p class="text-sm font-semibold text-amber-700">‡¶õ‡¶¨‡¶ø ‡¶ü‡ßá‡¶®‡ßá ‡¶Ü‡¶®‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                    <p class="text-xs text-gray-400 mt-0.5">JPEG, PNG, WebP ‚Ä¢ ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ßß‡ß¶‡¶ü‡¶ø ‚Ä¢ ‡ß´ MB ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø</p>
                </div>
                <div id="quick-preview-grid" class="upload-preview-grid"></div>
                <div id="quick-per-file-meta" class="mt-2 space-y-2"></div>
                <div class="flex gap-2 mt-3">
                   
                    <button type="button" id="quick-upload-btn"
                        onclick="submitQuickUpload()"
                        class="flex-1 py-1.5 px-4 rounded-lg font-bold text-sm
                               bg-gradient-to-r from-[#b45309] to-[#d97706] text-white
                               shadow hover:shadow-md transition-all active:scale-95 disabled:opacity-50">
                        ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                    <button type="button" onclick="closeQuickUpload()"
                        class="px-3 py-1.5 rounded-lg border border-gray-300 text-sm text-gray-600 hover:bg-gray-50">
                        ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                    </button>
                </div>
                <div id="quick-upload-status" class="hidden mt-2 text-sm font-semibold text-amber-700"></div>
            </div>

            <!-- Action buttons -->
            <div class="flex gap-3 mt-6 pt-5 border-t-2 border-[#fcd34d]">
                <button onclick="closeDetailModal(); editRecord(currentDetailId)" class="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg text-base transition-all active:scale-[0.98] hover:shadow-xl hover:from-blue-700 hover:to-blue-800">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                    ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ
                </button>
                <button data-role="admin" onclick="closeDetailModal(); deleteRecord(currentDetailId)" class="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold py-3.5 rounded-xl shadow-lg text-base transition-all active:scale-[0.98] hover:shadow-xl hover:from-red-700 hover:to-red-800">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®
                </button>
                <button onclick="closeDetailModal()" class="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold py-3.5 rounded-xl shadow-lg text-base transition-all active:scale-[0.98] hover:shadow-xl hover:from-gray-700 hover:to-gray-800">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Add/Edit Modal ‚îÄ‚îÄ -->
    <div id="form-modal" class="hidden fixed inset-0 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-xl bg-white mb-10">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-900" id="modal-title">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <button onclick="closeFormModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="project-form" class="space-y-6">
                <input type="hidden" id="record-id" name="id">

                <!-- Basic Info -->
                <div class="border-b pb-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶Ü‡¶á‡¶°‡¶ø <span class="text-red-500">*</span></label>
                            <input type="text" name="id" id="form-id" required placeholder="R-25-26-001" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶Ö‡¶∞‡ßç‡¶•‡¶¨‡¶õ‡¶∞ <span class="text-red-500">*</span></label>
                            <input type="text" name="financial_year" required placeholder="‡ß®‡ß¶‡ß®‡ß´-‡ß®‡ß¨" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ <span class="text-red-500">*</span></label>
                            <textarea name="project_name" required rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ <span class="text-red-500">*</span></label>
                            <input type="text" name="upazila" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶ß‡¶∞‡¶® <span class="text-red-500">*</span></label>
                            <select name="project_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                                <option value="‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</option>
                                <option value="‡¶ß‡¶∞‡ßç‡¶Æ‡ßÄ‡¶Ø‡¶º ‡¶ì ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶ú‡¶ø‡¶ï">‡¶ß‡¶∞‡ßç‡¶Æ‡ßÄ‡¶Ø‡¶º ‡¶ì ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶ú‡¶ø‡¶ï</option>
                                <option value="‡¶∏‡ßá‡¶¨‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï">‡¶∏‡ßá‡¶¨‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï</option>
                                <option value="‡¶ï‡ßç‡¶∞‡ßÄ‡¶°‡¶º‡¶æ">‡¶ï‡ßç‡¶∞‡ßÄ‡¶°‡¶º‡¶æ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø <span class="text-red-500">*</span></label>
                            <select name="implementation_method" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                                <option value="‡¶ü‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞">‡¶ü‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞</option>
                                <option value="‡¶∏‡¶ø‡¶™‡¶ø‡¶™‡¶ø‡¶∏‡¶ø">‡¶∏‡¶ø‡¶™‡¶ø‡¶™‡¶ø‡¶∏‡¶ø</option>
                                <option value="‡¶Ü‡¶∞‡¶è‡¶´‡¶ï‡¶ø‡¶â">‡¶Ü‡¶∞‡¶è‡¶´‡¶ï‡¶ø‡¶â</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶§‡¶π‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ß‡¶∞‡¶® <span class="text-red-500">*</span></label>
                            <input type="text" name="fund_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>
                </div>

                <!-- Financial Info -->
                <div class="border-b pb-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶∞‡¶æ‡¶¶‡ßç‡¶¶ (‡¶ü‡¶æ‡¶ï‡¶æ) <span class="text-red-500">*</span></label>
                            <input type="number" name="allocation_amount" required step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶õ‡¶æ‡¶°‡¶º‡¶ï‡ßÉ‡¶§ ‡¶Ö‡¶∞‡ßç‡¶• (‡¶ü‡¶æ‡¶ï‡¶æ)</label>
                            <input type="number" name="released_amount" step="0.01" min="0" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>
                </div>

                <!-- Status & Progress -->
                <div class="border-b pb-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶ì ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ <span class="text-red-500">*</span></label>
                            <input type="text" name="current_status" required value="‡¶ï‡¶æ‡¶ú ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø (%)</label>
                            <input type="number" name="progress_percentage" min="0" max="100" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div class="flex items-center gap-6 pt-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="is_completed" value="1" class="w-4 h-4 text-amber-600 rounded">
                                <span class="text-sm font-medium text-gray-700">‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="is_delayed" value="1" class="w-4 h-4 text-red-500 rounded">
                                <span class="text-sm font-medium text-gray-700">‡¶¨‡¶ø‡¶≤‡¶Æ‡ßç‡¶¨‡¶ø‡¶§</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Dates -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                            <input type="date" name="project_approval_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡¶ï ‡¶®‡¶Ç‡¶¨‡¶∞</label>
                            <input type="text" name="approval_memo_number" placeholder="‡ß¶‡ß¶.‡ß¶‡ß¶.‡ß©‡ß©‡ß™.‡ß®‡ß´.‡ß®‡ß¨.‡ß¶‡ß¶‡ßß.‡ß®‡ß©.‡ß´‡ßß‡ß´" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 font-mono">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                            <input type="date" name="start_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶∏‡¶Æ‡¶æ‡¶™‡ßç‡¶§‡¶ø</label>
                            <input type="date" name="expected_end_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶∏‡¶Æ‡¶æ‡¶™‡ßç‡¶§‡¶ø</label>
                            <input type="date" name="actual_end_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>
                    <!-- GPS location -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-1.5">
                            <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶ú‡¶ø‡¶™‡¶ø‡¶è‡¶∏ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® (Lat, Lng)
                        </label>
                        <div class="flex gap-2">
                            <input type="text" name="lat_lng" id="lat-lng-input" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 23.9012,89.1234"
                                pattern="^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 font-mono text-sm"
                                title="Latitude ‡¶è‡¶¨‡¶Ç Longitude ‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®, ‡¶Ø‡ßá‡¶Æ‡¶®: 23.9012,89.1234">
                            <button type="button" onclick="openLocationPicker()"
                                class="px-4 py-2 bg-gradient-to-r from-amber-600 to-amber-700 text-white rounded-lg hover:from-amber-700 hover:to-amber-800 transition-all shadow-md flex items-center gap-2 font-semibold text-sm">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                </svg>
                                ‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø Lat, Lng ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</p>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</label>
                        <textarea name="remarks" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"></textarea>
                    </div>
                </div>

                <!-- Photo Upload -->
                <div class="border-b pb-4" id="photo-upload-section">
                    <h4 class="text-lg font-semibold text-gray-800 mb-1">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø</h4>
                    <p class="text-xs text-gray-400 mb-3">‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ßß‡ß¶‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø (‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡ß´ MB ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§) ‚Äî JPEG, PNG, WebP</p>

                    <!-- Drag-drop / click zone -->
                    <div class="photo-upload-zone" id="upload-drop-zone">
                        <input type="file" id="photo-file-input" accept="image/jpeg,image/png,image/webp"
                               multiple max="10">
                        <svg class="w-8 h-8 mx-auto mb-2 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p class="text-sm font-semibold text-amber-700">‡¶õ‡¶¨‡¶ø ‡¶ü‡ßá‡¶®‡ßá ‡¶Ü‡¶®‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                        <p class="text-xs text-gray-400 mt-1">‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶õ‡¶¨‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®</p>
                    </div>

                    <!-- Per-file: type + caption row (rendered dynamically) -->
                    <div id="upload-preview-grid" class="upload-preview-grid"></div>

                    <!-- Global type selector (applies to all newly selected files if not set per-file) -->
                    <div class="flex items-center gap-3 mt-3 flex-wrap" id="upload-global-meta" style="display:none!important">
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶ß‡¶∞‡¶® (‡¶∏‡¶¨ ‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)</label>
                            <select id="upload-global-type" class="px-3 py-1.5 border border-amber-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 bg-white">
                                <option value="general">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option>
                                <option value="before">‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá</option>
                                <option value="during">‡¶ö‡¶≤‡¶æ‡¶ï‡¶æ‡¶≤‡ßÄ‡¶®</option>
                                <option value="after">‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶™‡¶∞‡ßá</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-0">
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∂‡¶® (‡¶∏‡¶¨ ‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø, ‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                            <input type="text" id="upload-global-caption" placeholder="‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‚Ä¶"
                                   class="w-full px-3 py-1.5 border border-amber-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>

                    <!-- Per-file metadata rows -->
                    <div id="upload-per-file-meta" class="mt-3 space-y-2"></div>

                    <!-- Upload status for edit mode -->
                    <div id="upload-status" class="hidden mt-2 text-sm font-semibold text-amber-700"></div>

                    <!-- Existing photos (shown in edit mode) -->
                    <div id="existing-photos-section" class="hidden mt-4">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶õ‡¶¨‡¶ø</p>
                        <div id="existing-photos-tabs" class="flex gap-2 flex-wrap mb-2"></div>
                        <div id="existing-photos-grid" class="upload-preview-grid"></div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeFormModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Location Picker Modal -->
    <div id="location-picker-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden" style="max-height: 90vh;">
            <!-- Header -->
            <div class="bg-gradient-to-r from-amber-600 to-amber-700 px-6 py-4 flex items-center justify-between">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    ‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </h3>
                <button onclick="closeLocationPicker()" class="text-white/80 hover:text-white transition-colors">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Content -->
            <div class="flex flex-col lg:flex-row" style="height: calc(90vh - 180px);">
                <!-- Search Panel -->
                <div class="lg:w-1/3 p-4 bg-gray-50 border-r border-gray-200 overflow-y-auto">
                    <div class="space-y-4">
                        <!-- Search Input -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</label>
                            <div class="relative">
                                <input type="text" id="location-search-input"
                                    placeholder="‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."
                                    class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                <svg class="w-5 h-5 text-gray-400 absolute right-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                        </div>

                        <!-- Get Current Location Button -->
                        <button onclick="getCurrentLocation()" id="current-location-btn"
                            class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all shadow-md flex items-center justify-center gap-2 font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®
                        </button>

                        <!-- Search Results -->
                        <div id="search-results" class="space-y-2">
                            <!-- Results will be inserted here -->
                        </div>

                        <!-- Selected Coordinates Display -->
                        <div id="selected-coords-display" class="hidden mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                            <p class="text-sm font-semibold text-amber-800 mb-1">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶∏‡ßç‡¶•‡¶æ‡¶®:</p>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span id="selected-coords-text" class="text-sm font-mono text-gray-800"></span>
                            </div>
                            <p id="selected-place-name" class="text-xs text-gray-600 mt-1"></p>
                        </div>
                    </div>
                </div>

                <!-- Map Panel -->
                <div class="lg:w-2/3 p-4">
                    <div class="h-full rounded-lg overflow-hidden border-2 border-gray-300 relative">
                        <div id="location-picker-map" class="w-full h-full"></div>
                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg border border-gray-200">
                            <p class="text-xs font-semibold text-gray-700">‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="bg-gray-50 px-6 py-4 flex gap-3 border-t border-gray-200">
                <button onclick="applySelectedLocation()"
                    class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition-all shadow-md flex items-center justify-center gap-2 font-bold">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <button onclick="closeLocationPicker()"
                    class="px-8 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all font-bold">
                    ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>

    <!-- Image Lightbox ‚Äî frosted glass card -->
    <div id="adm-lightbox" onclick="admLbBackdropClick(event)">
        <div class="adm-lb-card">
            <!-- Top bar: zoom controls ¬∑ counter ¬∑ close -->
            <div class="adm-lb-topbar">
                <div class="adm-lb-zoom-group">
                    <button class="adm-lb-zoom-btn" onclick="lightboxZoomOut()" title="Zoom Out (-)">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/>
                        </svg>
                    </button>
                    <span class="adm-lb-zoom-level" id="lightbox-zoom-level">100%</span>
                    <button class="adm-lb-zoom-btn" onclick="lightboxZoomIn()" title="Zoom In (+)">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"/>
                        </svg>
                    </button>
                    <button class="adm-lb-reset-btn" onclick="lightboxResetZoom()" title="Reset (0)">Reset</button>
                </div>
                <span class="adm-lb-counter" id="lightbox-counter">1 / 1</span>
                <button class="adm-lb-close" onclick="closeLightbox()" title="‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶® (Esc)">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.2">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Stage -->
            <div class="adm-lb-stage">
                <button class="adm-lb-arrow adm-lb-prev" id="lightbox-prev" onclick="lightboxPrevious()" title="‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ (‚Üê)">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M15 19l-7-7 7-7"/></svg>
                </button>
                <div class="adm-lb-img-wrap">
                    <img id="adm-lb-img" src="" alt="">
                </div>
                <button class="adm-lb-arrow adm-lb-next" id="lightbox-next" onclick="lightboxNext()" title="‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ (‚Üí)">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M9 5l7 7-7 7"/></svg>
                </button>
            </div>

            <!-- Caption -->
            <div class="adm-lb-caption" id="lightbox-caption"></div>

            <!-- Thumbnail strip -->
            <div class="adm-lb-strip-wrap">
                <div class="adm-lb-strip" id="lightbox-thumbnails"></div>
            </div>
        </div>
    </div>

    <!-- Full Screen Map Modal -->
    <div id="full-map-modal" class="hidden fixed inset-0 z-[300] bg-black/95 flex flex-col">
        <!-- Top Bar -->
        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-blue-600 to-blue-700">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <div>
                    <h3 class="text-white font-bold text-lg" id="full-map-title">‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®</h3>
                    <p class="text-white/80 text-sm" id="full-map-coords"></p>
                </div>
            </div>
            <button onclick="closeFullMap()" class="text-white/80 hover:text-white transition-colors">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Map Container -->
        <div id="full-map-container" class="flex-1"></div>

        <!-- Bottom Info Bar -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-3 flex items-center justify-between">
            <div class="text-white/90 text-sm" id="full-map-project-name"></div>
            <a id="full-map-google-link" href="#" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 text-white text-sm font-semibold rounded-lg transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
                ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®
            </a>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-container"></div>

    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components.js"></script>
    <script src="assets/js/crud.js"></script>

    <script>
        // Tom Select init
        const _tomInstances = new Map();
        function initTomSelects() {
            document.querySelectorAll('select').forEach(el => {
                if (!_tomInstances.has(el)) {
                    _tomInstances.set(el, new TomSelect(el, {
                        create: false,
                        sortField: false,
                        allowEmptyOption: true,
                        controlInput: null,
                        onInitialize() { this.control.style.fontFamily = "'Hind Siliguri', sans-serif"; }
                    }));
                }
            });
        }
        document.addEventListener('DOMContentLoaded', initTomSelects);
        document.addEventListener('DOMContentLoaded', () => {
            if (CRUDManager && CRUDManager.openModal) {
                const orig = CRUDManager.openModal.bind(CRUDManager);
                CRUDManager.openModal = function(id) { orig(id); setTimeout(initTomSelects, 50); };
            }
        });
    </script>
    <script>
        DashboardComponents.loadAll('projects', '‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ');

        let currentPage = 1;
        let currentSearch = '';
        let currentYear = '';
        let currentMethod = '';
        let currentStatus = '';
        let editingId = null;
        let currentDetailId = null;
        let allRecords = [];
        let sortColumn = '';
        let sortDirection = 'asc';

        // Initialize ‚Äî load data immediately (list/years are public endpoints),
        // run auth check in parallel for redirect protection and role-based UI.
        AuthManager.init(); // handles redirect to login if unauthenticated
        loadYears().then(() => loadData());

        // Search debounce
        const searchInput = document.getElementById('search-input');
        const debouncedSearch = CRUDManager.debounce(() => {
            currentSearch = searchInput.value;
            currentPage = 1;
            loadData();
        }, 500);
        searchInput.addEventListener('input', debouncedSearch);

        // Year filter
        document.getElementById('year-filter').addEventListener('change', (e) => {
            currentYear = e.target.value;
            currentPage = 1;
            loadData();
        });

        // Method filter (client-side)
        document.getElementById('method-filter').addEventListener('change', (e) => {
            currentMethod = e.target.value;
            currentPage = 1;
            renderRows();
        });

        // Status filter (client-side)
        document.getElementById('status-filter').addEventListener('change', (e) => {
            currentStatus = e.target.value;
            currentPage = 1;
            renderRows();
        });

        async function loadYears() {
            try {
                const years = await CRUDManager.fetchList('/projects/years');
                const select = document.getElementById('year-filter');
                const ts = _tomInstances.get(select);
                years.forEach(year => {
                    const label = CRUDManager.toBengaliNumber(year);
                    if (ts) {
                        ts.addOption({ value: year, text: label });
                    } else {
                        const opt = document.createElement('option');
                        opt.value = year;
                        opt.textContent = label;
                        select.appendChild(opt);
                    }
                });
                if (ts) ts.refreshOptions(false);
            } catch (err) {
                console.error('Failed to load years:', err);
            }
        }

        async function loadData() {
            const tbody = document.getElementById('table-body');
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const tableContainer = document.getElementById('table-container');

            try {
                loading.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                emptyState.classList.add('hidden');

                const response = await CRUDManager.fetchList('/projects/list', {
                    page: currentPage, limit: 20,
                    search: currentSearch, year: currentYear
                });

                loading.classList.add('hidden');

                if (!response.data || response.data.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }

                tableContainer.classList.remove('hidden');
                allRecords = response.data;
                renderRows();

                CRUDManager.createPagination(response.total, currentPage, 20, 'pagination-container', 'changePage');
            } catch (err) {
                loading.classList.add('hidden');
                CRUDManager.showError('‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + err.message);
            }
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            document.querySelectorAll('.sortable-th').forEach(th => {
                th.classList.remove('active');
                const icon = th.querySelector('.sort-icon');
                if (icon) icon.style.transform = 'rotate(0deg)';
            });
            const activeTh = document.querySelector(`[data-col="${sortColumn}"]`);
            if (activeTh) {
                activeTh.classList.add('active');
                const icon = activeTh.querySelector('.sort-icon');
                if (icon && sortDirection === 'desc') icon.style.transform = 'rotate(180deg)';
            }
            renderRows();
        }

        function statusBadge(r) {
            if (r.is_completed) return '<span class="px-3 py-1.5 rounded-full text-sm font-bold badge-completed inline-block">‚úÖ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</span>';
            if (r.is_delayed)   return '<span class="px-3 py-1.5 rounded-full text-sm font-bold badge-delayed inline-block">‚ö†Ô∏è ‡¶¨‡¶ø‡¶≤‡¶Æ‡ßç‡¶¨‡¶ø‡¶§</span>';
            if (r.progress_percentage > 0) return '<span class="px-3 py-1.5 rounded-full text-sm font-bold badge-ongoing inline-block">üîÑ ‡¶ö‡¶≤‡¶Æ‡¶æ‡¶®</span>';
            return '<span class="px-3 py-1.5 rounded-full text-sm font-bold badge-pending inline-block">‚è≥ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®</span>';
        }

        function progressColor(pct) {
            if (pct >= 100) return 'bg-green-500';
            if (pct >= 60)  return 'bg-amber-500';
            if (pct >= 30)  return 'bg-blue-500';
            return 'bg-gray-400';
        }

        function getStatusKey(r) {
            if (r.is_completed) return 'completed';
            if (r.is_delayed)   return 'delayed';
            if (parseInt(r.progress_percentage) > 0) return 'ongoing';
            return 'pending';
        }

        function renderRows() {
            const tbody = document.getElementById('table-body');
            const tableContainer = document.getElementById('table-container');
            const emptyState = document.getElementById('empty-state');

            let records = [...allRecords];

            // Client-side method filter
            if (currentMethod) {
                records = records.filter(r => r.implementation_method === currentMethod);
            }

            // Client-side status filter
            if (currentStatus) {
                records = records.filter(r => getStatusKey(r) === currentStatus);
            }

            // Show/hide table based on filtered result
            if (records.length === 0) {
                tableContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            } else {
                tableContainer.classList.remove('hidden');
                emptyState.classList.add('hidden');
            }

            if (sortColumn) {
                records.sort((a, b) => {
                    let aVal = a[sortColumn] ?? '';
                    let bVal = b[sortColumn] ?? '';
                    if (sortColumn === 'allocation_amount' || sortColumn === 'progress_percentage') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                        return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                    const cmp = String(aVal).localeCompare(String(bVal), 'bn');
                    return sortDirection === 'asc' ? cmp : -cmp;
                });
            }

            tbody.innerHTML = '';
            records.forEach(record => {
                const pct = parseInt(record.progress_percentage) || 0;
                const row = document.createElement('tr');
                row.className = 'table-row cursor-pointer';
                row.addEventListener('click', () => showDetailModal(record));
                row.innerHTML = `
                    <!-- Project name + type -->
                    <td class="px-4 py-2.5">
                        <p class="text-base font-medium text-gray-900 truncate">${CRUDManager.escapeHtml(record.project_name)}</p>
                        <p class="text-xs text-gray-500 mt-0.5 truncate">${CRUDManager.escapeHtml(record.project_type || '')}</p>
                    </td>
                    <!-- Upazila -->
                    <td class="px-4 py-2.5">
                        <p class="text-base text-gray-700 truncate">${CRUDManager.escapeHtml(record.upazila || '-')}</p>
                    </td>
                    <!-- Fund source -->
                    <td class="px-4 py-2.5">
                        <p class="text-base text-gray-700 truncate">${CRUDManager.escapeHtml(record.fund_type || '-')}</p>
                    </td>
                    <!-- Financial year -->
                    <td class="px-4 py-2.5 text-center">
                        <p class="text-base font-medium text-gray-600">${CRUDManager.toBengaliNumber(record.financial_year || '-')}</p>
                    </td>
                    <!-- Progress bar -->
                    <td class="px-4 py-2.5">
                        <div class="flex items-center gap-2">
                            <div class="flex-1 progress-bar-bg">
                                <div class="progress-bar-fill ${progressColor(pct)}" style="width:${pct}%"></div>
                            </div>
                            <span class="text-xs font-bold text-gray-700 w-8 text-right">${CRUDManager.toBengaliNumber(pct)}%</span>
                        </div>
                    </td>
                    <!-- Status badge -->
                    <td class="px-4 py-2.5 text-center">
                        ${statusBadge(record)}
                    </td>
                    <!-- Amount -->
                    <td class="px-4 py-2.5 text-right">
                        <div class="currency-amount inline-flex font-bold text-gray-900 text-base">
                            <span class="currency-symbol">‡ß≥</span>
                            <span>${CRUDManager.toBengaliNumber(parseFloat(record.allocation_amount || 0).toLocaleString('en-IN'))}</span>
                        </div>
                    </td>
                    <!-- Action buttons -->
                    <td class="px-4 py-2.5 text-center" onclick="event.stopPropagation()">
                        <div class="flex justify-center gap-1.5">
                            <button onclick="editRecord('${record.id}')" class="action-btn p-1.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600" title="‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </button>
                            ${AuthManager.isAdmin() ? `<button onclick="deleteRecord('${record.id}')" class="action-btn p-1.5 bg-red-500 text-white rounded-lg hover:bg-red-600" title="‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showDetailModal(r) {
            console.log('showDetailModal called with record:', r);
            currentDetailId = r.id;

            // Project name
            document.getElementById('dm-name').innerText = r.project_name || '';

            // Quick Info Row
            document.getElementById('dm-quick-type').innerText = r.project_type || '';
            document.getElementById('dm-quick-method').innerText = r.implementation_method || '';
            document.getElementById('dm-quick-status').innerText = r.current_status || '';

            // Details
            document.getElementById('dm-id').innerText = r.project_id || r.id || '';
            document.getElementById('dm-year').innerText = r.financial_year || '';
            document.getElementById('dm-upazila').innerText = r.upazila || '';
            document.getElementById('dm-fund-type').innerText = r.fund_type || '';
            document.getElementById('dm-status').innerText = r.current_status || '';

            // Approval date (Row 2, right column)
            document.getElementById('dm-approval-date').innerText = r.project_approval_date ? CRUDManager.formatDate(r.project_approval_date) : 'N/A';
            document.getElementById('dm-memo-number').innerText = r.approval_memo_number || 'N/A';

            // Progress percentage for the progress bars
            const pct = r.progress_percentage || 0;
            document.getElementById('dm-progress-pct').innerText = pct + '%';
            document.getElementById('dm-progress-bar').style.width = pct + '%';

            // Fund release percentage
            const alloc   = parseFloat(r.allocation_amount) || 0;
            const released = parseFloat(r.released_amount) || 0;
            const fundPct = alloc > 0 ? Math.min(Math.round((released / alloc) * 100), 100) : 0;
            document.getElementById('dm-fund-release-pct').innerText = fundPct + '%';
            document.getElementById('dm-fund-release-bar').style.width = fundPct + '%';

            // Dates
            document.getElementById('dm-start').innerText = r.start_date ? CRUDManager.formatDate(r.start_date) : 'N/A';
            document.getElementById('dm-expected-end').innerText = r.expected_end_date ? CRUDManager.formatDate(r.expected_end_date) : 'N/A';
            document.getElementById('dm-actual-end').innerText = r.actual_end_date ? CRUDManager.formatDate(r.actual_end_date) : 'N/A';

            // Remarks
            const remarksWrap = document.getElementById('dm-remarks-wrap');
            if (r.remarks && r.remarks.trim()) {
                document.getElementById('dm-remarks').innerText = r.remarks;
                remarksWrap.classList.remove('hidden');
            } else {
                remarksWrap.classList.add('hidden');
            }

            // Amounts
            document.getElementById('dm-allocation').innerText = '‡ß≥ ' + parseFloat(r.allocation_amount || 0).toLocaleString('en-IN') + ' ‡¶ü‡¶æ‡¶ï‡¶æ';
            document.getElementById('dm-released').innerText = '‡ß≥ ' + parseFloat(r.released_amount || 0).toLocaleString('en-IN') + ' ‡¶ü‡¶æ‡¶ï‡¶æ';

            // Progress log ‚Äî fetch and render
            const logSection = document.getElementById('dm-progress-log-section');
            const logList    = document.getElementById('dm-progress-log-list');
            logSection.classList.add('hidden');
            logList.innerHTML = '<p class="text-xs text-[#b45309] opacity-60 text-center py-2">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</p>';

            fetch(`${AuthManager.API_URL}/projects/${r.id}/progress`)
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(logs => {
                    if (!logs || logs.length === 0) {
                        logSection.classList.add('hidden');
                        return;
                    }
                    logList.innerHTML = logs.map(log => {
                        const dotClass = log.is_completed
                            ? 'plog-dot-complete'
                            : log.is_delayed ? 'plog-dot-delayed' : 'plog-dot-normal';
                        const flag = log.is_completed
                            ? '<span class="plog-flag plog-flag-complete">‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</span>'
                            : log.is_delayed
                                ? '<span class="plog-flag plog-flag-delayed">‡¶¨‡¶ø‡¶≤‡¶Æ‡ßç‡¶¨</span>'
                                : '';
                        const note = log.note
                            ? `<p class="plog-note">${log.note}</p>` : '';
                        return `
                        <div class="progress-log-row">
                            <span class="plog-dot ${dotClass}"></span>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start gap-2 flex-wrap">
                                    <span class="plog-status">${log.current_status}</span>
                                    ${flag}
                                </div>
                                ${note}
                            </div>
                            <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                <span class="plog-pct">${log.progress_percentage}%</span>
                                <span class="plog-date">${CRUDManager.formatDate(log.logged_at)}</span>
                            </div>
                        </div>`;
                    }).join('');
                    logSection.classList.remove('hidden');
                })
                .catch(() => { logSection.classList.add('hidden'); });

            // Photos ‚Äî fetch and render gallery
            loadProjectPhotos(r.id);

            // Open modal FIRST so the container has real pixel dimensions
            document.getElementById('detail-modal').classList.add('open');

            // Location map ‚Äî called after modal is open (modal transition = 0.28s)
            // 350ms gives the animation time to complete before Leaflet measures the container
            loadProjectMap(r.lat_lng, r.project_name, r.upazila);
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('open');
        }

        document.getElementById('detail-modal').addEventListener('click', function(e) {
            if (e.target === this) closeDetailModal();
        });

        // ‚îÄ‚îÄ Project Location Map (Leaflet) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _leafletMap = null;
        let _leafletMarker = null;

        function loadProjectMap(latLng, projectName, upazila) {
            const section = document.getElementById('dm-map-section');
            const container = document.getElementById('m-map-container');
            const coordText = document.getElementById('dm-coord-text');
            const mapLink   = document.getElementById('dm-map-link');

            // Hide if no coordinates
            if (!latLng || !latLng.trim()) {
                section.classList.add('hidden');
                return;
            }

            const parts = latLng.split(',').map(s => parseFloat(s.trim()));
            if (parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) {
                section.classList.add('hidden');
                return;
            }
            const [lat, lng] = parts;

            section.classList.remove('hidden');
            coordText.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            mapLink.href = `https://www.google.com/maps?q=${lat},${lng}`;

            // Leaflet must initialise after the modal is visible (transition = 0.28s).
            // 350ms gives a safe margin; a second invalidateSize at 900ms
            // ensures tiles reload even if the scroll container caused a layout shift.
            setTimeout(() => {
                // Shared popup HTML
                const popupHtml = `
                    <div style="font-family:'Hind Siliguri',sans-serif;min-width:180px;line-height:1.5">
                        <p style="font-weight:700;font-size:13px;color:#0f172a;margin:0 0 4px">${projectName || ''}</p>
                        <p style="font-size:11px;color:#b45309;font-weight:600;margin:0">üìç ${upazila || ''}</p>
                        <p style="font-size:10px;color:#64748b;margin:4px 0 0;font-family:monospace">${lat.toFixed(5)}, ${lng.toFixed(5)}</p>
                    </div>`;

                // Amber pin icon
                const amberIcon = L.divIcon({
                    className: '',
                    html: `<div style="
                        width:38px;height:38px;
                        background:linear-gradient(135deg,#b45309,#d97706);
                        border-radius:50% 50% 50% 0;
                        transform:rotate(-45deg);
                        border:3px solid #fff;
                        box-shadow:0 3px 12px rgba(180,83,9,0.5);
                        display:flex;align-items:center;justify-content:center;
                    "><svg style="transform:rotate(45deg);width:16px;height:16px;" fill="white"
                        viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/></svg></div>`,
                    iconSize: [38, 38],
                    iconAnchor: [19, 38],
                    popupAnchor: [0, -40],
                });

                if (_leafletMap) {
                    // Reuse: pan to new location
                    _leafletMap.setView([lat, lng], 14, { animate: false });
                    if (_leafletMarker) {
                        _leafletMarker.setLatLng([lat, lng]);
                        _leafletMarker.setPopupContent(popupHtml);
                        _leafletMarker.openPopup();
                    } else {
                        _leafletMarker = L.marker([lat, lng], { icon: amberIcon })
                            .addTo(_leafletMap)
                            .bindPopup(popupHtml, { maxWidth: 240 })
                            .openPopup();
                    }
                } else {
                    // First open: create map
                    _leafletMap = L.map(container, {
                        zoomControl: true,
                        scrollWheelZoom: false,
                        attributionControl: true,
                    });
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    }).addTo(_leafletMap);
                    _leafletMap.setView([lat, lng], 14);
                    _leafletMarker = L.marker([lat, lng], { icon: amberIcon })
                        .addTo(_leafletMap)
                        .bindPopup(popupHtml, { maxWidth: 240 })
                        .openPopup();
                }

                // First invalidateSize ‚Äî forces Leaflet to measure the container
                _leafletMap.invalidateSize();

                // Second invalidateSize after tiles have had time to load
                // (scroll containers can cause a layout shift that needs re-measuring)
                setTimeout(() => { _leafletMap.invalidateSize(); }, 500);
            }, 350);
        }

        // ‚îÄ‚îÄ Photo gallery ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let allPhotos = [];
        let activePhotoType = 'all';

        const PHOTO_TYPE_LABELS = {
            before:  '‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá',
            during:  '‡¶ö‡¶≤‡¶æ‡¶ï‡¶æ‡¶≤‡ßÄ‡¶®',
            after:   '‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶™‡¶∞‡ßá',
            general: '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£'
        };

        async function loadProjectPhotos(projectId) {
            const section  = document.getElementById('dm-photos-section');
            const grid     = document.getElementById('dm-photos-grid');
            const tabsEl   = document.getElementById('dm-photos-tabs');
            const noPhotosMsg = document.getElementById('dm-no-photos-msg');

            section.classList.add('hidden');
            grid.innerHTML = '';
            tabsEl.innerHTML = '';
            allPhotos = [];
            activePhotoType = 'all';

            // Hide no-photos message initially
            if (noPhotosMsg) noPhotosMsg.classList.add('hidden');

            try {
                const res = await fetch(`${AuthManager.API_URL}/projects/${projectId}/images`);
                if (!res.ok) return;
                const photos = await res.json();

                // Show section even if no photos
                section.classList.remove('hidden');

                if (!photos || photos.length === 0) {
                    // Show no-photos message, hide grid and tabs
                    if (noPhotosMsg) noPhotosMsg.classList.remove('hidden');
                    grid.classList.add('hidden');
                    tabsEl.classList.add('hidden');
                    return;
                }

                // Hide no-photos message, show grid and tabs
                if (noPhotosMsg) noPhotosMsg.classList.add('hidden');
                grid.classList.remove('hidden');
                tabsEl.classList.remove('hidden');

                allPhotos = photos;

                // Build type filter tabs
                const types = ['all', ...new Set(photos.map(p => p.photo_type))];
                types.forEach(type => {
                    const tab = document.createElement('button');
                    tab.className = 'photo-tab' + (type === 'all' ? ' active' : '');
                    tab.textContent = type === 'all' ? `‡¶∏‡¶¨ (${photos.length})` : PHOTO_TYPE_LABELS[type] || type;
                    tab.dataset.type = type;
                    tab.onclick = () => {
                        document.querySelectorAll('.photo-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        activePhotoType = type;
                        renderPhotoGrid(type);
                    };
                    tabsEl.appendChild(tab);
                });

                renderPhotoGrid('all');
            } catch (e) {
                // silently hide on error
            }
        }

        function renderPhotoGrid(typeFilter) {
            const grid = document.getElementById('dm-photos-grid');
            grid.innerHTML = '';
            const filtered = typeFilter === 'all'
                ? allPhotos
                : allPhotos.filter(p => p.photo_type === typeFilter);

            filtered.forEach((photo) => {
                const typeClass = `ptype-${photo.photo_type}`;
                const typeLabel = PHOTO_TYPE_LABELS[photo.photo_type] || photo.photo_type;

                const thumb = document.createElement('div');
                thumb.className = 'photo-thumb';
                thumb.dataset.photoId = photo.id;
                thumb.innerHTML = `
                    <img src="/uploads/${photo.photo_path}" alt="${photo.caption || '‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø'}"
                        onclick="openLightbox('/uploads/${photo.photo_path}')"
                        style="cursor: pointer;"
                        onerror="this.parentElement.style.display='none'">
                    <span class="photo-type-badge ${typeClass}">${typeLabel}</span>
                    <button class="photo-delete-btn" title="‡¶õ‡¶¨‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®"
                        onclick="deleteDetailPhoto(${photo.id}, this); event.stopPropagation();">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <path d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>`;
                grid.appendChild(thumb);
            });
        }

        async function deleteDetailPhoto(imageId, btn) {
            if (!confirm('‡¶è‡¶á ‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) return;
            try {
                btn.disabled = true;
                const url = `${AuthManager.API_URL}/projects/${currentDetailId}/images/${imageId}`;
                const res = await AuthManager.fetch(url, { method: 'DELETE' });
                if (!res.ok) throw new Error('‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•');
                // Remove from allPhotos and re-render
                allPhotos = allPhotos.filter(p => p.id !== imageId);
                renderPhotoGrid(activePhotoType);
                // Update tab counts
                const tabsEl = document.getElementById('dm-photos-tabs');
                tabsEl.querySelector('[data-type="all"]') && (
                    tabsEl.querySelector('[data-type="all"]').textContent = `‡¶∏‡¶¨ (${allPhotos.length})`
                );
                if (allPhotos.length === 0) document.getElementById('dm-photos-section').classList.add('hidden');
                CRUDManager.showSuccess('‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            } catch (e) {
                btn.disabled = false;
                CRUDManager.showError('‡¶õ‡¶¨‡¶ø ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•');
            }
        }

        function changePage(page) {
            currentPage = page;
            loadData();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function openAddModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = '‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
            document.getElementById('project-form').reset();
            document.getElementById('form-id').removeAttribute('readonly');
            // Clear photo upload state
            pendingFiles = [];
            renderPendingPreviews();
            document.getElementById('upload-status').classList.add('hidden');
            document.getElementById('existing-photos-section').classList.add('hidden');
            document.getElementById('existing-photos-grid').innerHTML = '';
            document.getElementById('existing-photos-tabs').innerHTML = '';
            CRUDManager.openModal('form-modal');
        }

        function closeFormModal() {
            CRUDManager.closeModal('form-modal');
            editingId = null;
            pendingFiles = [];
            renderPendingPreviews();
            document.getElementById('upload-status').classList.add('hidden');
        }

        async function editRecord(id) {
            try {
                editingId = id;
                const record = await CRUDManager.fetchList(`/projects/${id}`);

                document.getElementById('modal-title').textContent = '‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ';

                const form = document.getElementById('project-form');
                CRUDManager.populateForm(form, record);

                // Handle checkboxes manually
                form.querySelector('[name="is_completed"]').checked = !!record.is_completed;
                form.querySelector('[name="is_delayed"]').checked = !!record.is_delayed;

                // ID field readonly while editing (ID is the PK)
                document.getElementById('form-id').setAttribute('readonly', 'readonly');

                // Clear pending photo state for this edit session
                pendingFiles = [];
                renderPendingPreviews();
                document.getElementById('upload-status').classList.add('hidden');

                // Load existing photos into the form
                loadExistingPhotosForForm(id);

                // Sync Tom Select instances
                _tomInstances.forEach((ts, el) => { if (el.closest('#form-modal')) ts.sync(); });

                CRUDManager.openModal('form-modal');
            } catch (err) {
                CRUDManager.showError('‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + err.message);
            }
        }

        async function deleteRecord(id) {
            try {
                const confirmed = await CRUDManager.confirm(`"${id}" ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`);
                if (!confirmed) return;
                const url = `${AuthManager.API_URL}/projects/${id}`;
                await AuthManager.fetch(url, { method: 'DELETE' });
                CRUDManager.showSuccess('‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                await loadData();
            } catch (err) {
                CRUDManager.showError('‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + err.message);
            }
        }

        // ‚îÄ‚îÄ Photo upload state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let pendingFiles = []; // Array of { file, type, caption }

        const PHOTO_TYPES_BD = {
            general: '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£', before: '‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá',
            during: '‡¶ö‡¶≤‡¶æ‡¶ï‡¶æ‡¶≤‡ßÄ‡¶®', after: '‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶™‡¶∞‡ßá'
        };

        function initPhotoUpload() {
            const zone  = document.getElementById('upload-drop-zone');
            const input = document.getElementById('photo-file-input');

            input.addEventListener('change', () => addFiles(Array.from(input.files)));
            zone.addEventListener('dragover',  e => { e.preventDefault(); zone.classList.add('drag-over'); });
            zone.addEventListener('dragleave', ()  => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                addFiles(Array.from(e.dataTransfer.files).filter(f =>
                    ['image/jpeg','image/jpg','image/png','image/webp'].includes(f.type)
                ));
                input.value = '';
            });
        }

        function addFiles(files) {
            const remaining = 10 - pendingFiles.length;
            if (remaining <= 0) { CRUDManager.showError('‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ßß‡ß¶‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá'); return; }
            const toAdd = files.slice(0, remaining);
            toAdd.forEach(f => {
                if (f.size > 5 * 1024 * 1024) {
                    CRUDManager.showError(`"${f.name}" ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡ß´ MB ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø`);
                    return;
                }
                pendingFiles.push({ file: f, type: 'general', caption: '' });
            });
            renderPendingPreviews();
            document.getElementById('photo-file-input').value = '';
        }

        function renderPendingPreviews() {
            const grid = document.getElementById('upload-preview-grid');
            const metaEl = document.getElementById('upload-per-file-meta');
            grid.innerHTML = '';
            metaEl.innerHTML = '';

            if (pendingFiles.length === 0) return;

            pendingFiles.forEach((item, idx) => {
                // Thumbnail
                const wrap = document.createElement('div');
                wrap.className = 'upload-preview-item';

                const img = document.createElement('img');
                img.src = URL.createObjectURL(item.file);
                img.onload = () => URL.revokeObjectURL(img.src);
                wrap.appendChild(img);

                const badge = document.createElement('span');
                badge.className = 'preview-type-badge';
                badge.textContent = PHOTO_TYPES_BD[item.type] || item.type;
                wrap.appendChild(badge);

                const rmBtn = document.createElement('button');
                rmBtn.type = 'button';
                rmBtn.className = 'preview-remove';
                rmBtn.title = '‡¶∏‡¶∞‡¶æ‡¶®';
                rmBtn.innerHTML = '‚úï';
                rmBtn.onclick = () => { pendingFiles.splice(idx, 1); renderPendingPreviews(); };
                wrap.appendChild(rmBtn);
                grid.appendChild(wrap);

                // Per-file type + caption row
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2';
                row.innerHTML = `
                    <span class="text-xs text-gray-500 truncate max-w-[120px]" title="${item.file.name}">${item.file.name}</span>
                    <select class="px-2 py-1 border border-amber-300 rounded text-xs focus:ring-1 focus:ring-amber-500 bg-white ml-auto"
                        data-idx="${idx}" data-field="type">
                        ${Object.entries(PHOTO_TYPES_BD).map(([v,l]) =>
                            `<option value="${v}"${item.type===v?' selected':''}>${l}</option>`
                        ).join('')}
                    </select>
                    <input type="text" placeholder="‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∂‡¶® (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)"
                        class="flex-1 min-w-0 px-2 py-1 border border-amber-300 rounded text-xs focus:ring-1 focus:ring-amber-500"
                        value="${item.caption}" data-idx="${idx}" data-field="caption">`;
                row.querySelector('[data-field="type"]').addEventListener('change', e => {
                    pendingFiles[idx].type = e.target.value;
                    badge.textContent = PHOTO_TYPES_BD[e.target.value] || e.target.value;
                });
                row.querySelector('[data-field="caption"]').addEventListener('input', e => {
                    pendingFiles[idx].caption = e.target.value;
                });
                metaEl.appendChild(row);
            });
        }

        async function uploadPendingPhotos(projectId) {
            if (pendingFiles.length === 0) return;

            const statusEl = document.getElementById('upload-status');
            statusEl.classList.remove('hidden');
            statusEl.textContent = `${pendingFiles.length}‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶`;

            const fd = new FormData();
            pendingFiles.forEach(item => {
                fd.append('images', item.file);
                fd.append('photo_type', item.type);
                fd.append('caption', item.caption || '');
            });

            const url = `${AuthManager.API_URL}/projects/${projectId}/images`;
            const res = await AuthManager.fetch(url, { method: 'POST', body: fd });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || '‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•');
            }

            statusEl.textContent = `${pendingFiles.length}‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚úì`;
            pendingFiles = [];
            renderPendingPreviews();
        }

        async function loadExistingPhotosForForm(projectId) {
            const section = document.getElementById('existing-photos-section');
            const grid    = document.getElementById('existing-photos-grid');
            const tabsEl  = document.getElementById('existing-photos-tabs');
            section.classList.add('hidden');
            grid.innerHTML = '';
            tabsEl.innerHTML = '';

            if (!projectId) return;
            try {
                const res = await fetch(`${AuthManager.API_URL}/projects/${projectId}/images`);
                if (!res.ok) return;
                const photos = await res.json();
                if (!photos || !photos.length) return;

                section.classList.remove('hidden');
                renderExistingPhotoGrid(photos, projectId, grid, tabsEl);
            } catch(e) { /* silently skip */ }
        }

        function renderExistingPhotoGrid(photos, projectId, grid, tabsEl) {
            // Build simple type tabs
            const types = ['all', ...new Set(photos.map(p => p.photo_type))];
            tabsEl.innerHTML = '';
            types.forEach(type => {
                const tab = document.createElement('button');
                tab.type = 'button';
                tab.className = 'photo-tab' + (type === 'all' ? ' active' : '');
                tab.textContent = type === 'all' ? `‡¶∏‡¶¨ (${photos.length})` : PHOTO_TYPE_LABELS[type] || type;
                tab.dataset.type = type;
                tab.onclick = () => {
                    tabsEl.querySelectorAll('.photo-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const filtered = type === 'all' ? photos : photos.filter(p => p.photo_type === type);
                    renderExistingGrid(filtered, photos, projectId, grid, tabsEl);
                };
                tabsEl.appendChild(tab);
            });
            renderExistingGrid(photos, photos, projectId, grid, tabsEl);
        }

        function renderExistingGrid(filtered, allPh, projectId, grid, tabsEl) {
            grid.innerHTML = '';
            filtered.forEach(photo => {
                const item = document.createElement('div');
                item.className = 'upload-preview-item';
                item.innerHTML = `
                    <img src="/uploads/${photo.photo_path}" alt="${photo.caption||''}"
                        onerror="this.parentElement.style.display='none'">
                    <span class="preview-type-badge">${PHOTO_TYPE_LABELS[photo.photo_type]||photo.photo_type}</span>
                    <button type="button" class="preview-remove" title="‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®"
                        data-id="${photo.id}">‚úï</button>`;
                item.querySelector('.preview-remove').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (!confirm('‡¶è‡¶á ‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) return;
                    try {
                        const url = `${AuthManager.API_URL}/projects/${projectId}/images/${photo.id}`;
                        const r = await AuthManager.fetch(url, { method: 'DELETE' });
                        if (!r.ok) throw new Error();
                        const idx = allPh.findIndex(p => p.id === photo.id);
                        if (idx > -1) allPh.splice(idx, 1);
                        renderExistingPhotoGrid(allPh, projectId, grid, tabsEl);
                        if (allPh.length === 0) document.getElementById('existing-photos-section').classList.add('hidden');
                        CRUDManager.showSuccess('‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                    } catch(e) {
                        CRUDManager.showError('‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•');
                    }
                });
                grid.appendChild(item);
            });
        }

        // ‚îÄ‚îÄ Quick Upload (inside detail modal) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let quickFiles = [];

        function openQuickUpload() {
            quickFiles = [];
            renderQuickPreviews();
            document.getElementById('quick-upload-panel').classList.remove('hidden');
            document.getElementById('quick-upload-status').classList.add('hidden');
        }
        function closeQuickUpload() {
            document.getElementById('quick-upload-panel').classList.add('hidden');
            quickFiles = [];
            renderQuickPreviews();
        }

        function initQuickUpload() {
            const zone  = document.getElementById('quick-drop-zone');
            const input = document.getElementById('quick-file-input');
            input.addEventListener('change', () => { addQuickFiles(Array.from(input.files)); input.value=''; });
            zone.addEventListener('dragover',  e => { e.preventDefault(); zone.classList.add('drag-over'); });
            zone.addEventListener('dragleave', ()  => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault(); zone.classList.remove('drag-over');
                addQuickFiles(Array.from(e.dataTransfer.files).filter(f =>
                    ['image/jpeg','image/jpg','image/png','image/webp'].includes(f.type)));
            });
        }

        function addQuickFiles(files) {
            const rem = 10 - quickFiles.length;
            if (rem <= 0) { CRUDManager.showError('‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ßß‡ß¶‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø'); return; }
            files.slice(0, rem).forEach(f => {
                if (f.size > 5*1024*1024) { CRUDManager.showError(`"${f.name}" ‡ß´MB ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø`); return; }
                quickFiles.push({ file: f, type: 'general', caption: '' });
            });
            renderQuickPreviews();
        }

        function renderQuickPreviews() {
            const grid = document.getElementById('quick-preview-grid');
            const meta = document.getElementById('quick-per-file-meta');
            grid.innerHTML = ''; meta.innerHTML = '';
            quickFiles.forEach((item, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'upload-preview-item';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(item.file);
                img.onload = () => URL.revokeObjectURL(img.src);
                wrap.appendChild(img);
                const badge = document.createElement('span');
                badge.className = 'preview-type-badge';
                badge.textContent = PHOTO_TYPES_BD[item.type];
                wrap.appendChild(badge);
                const rm = document.createElement('button');
                rm.type = 'button'; rm.className = 'preview-remove'; rm.innerHTML = '‚úï';
                rm.onclick = () => { quickFiles.splice(idx,1); renderQuickPreviews(); };
                wrap.appendChild(rm);
                grid.appendChild(wrap);

                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2';
                row.innerHTML = `
                    <span class="text-xs text-gray-500 truncate max-w-[100px]">${item.file.name}</span>
                    <select class="px-2 py-1 border border-amber-300 rounded text-xs bg-white ml-auto">
                        ${Object.entries(PHOTO_TYPES_BD).map(([v,l]) =>
                            `<option value="${v}"${item.type===v?' selected':''}>${l}</option>`).join('')}
                    </select>
                    <input type="text" placeholder="‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∂‡¶®" value="${item.caption}"
                        class="flex-1 min-w-0 px-2 py-1 border border-amber-300 rounded text-xs">`;
                row.querySelector('select').addEventListener('change', e => {
                    quickFiles[idx].type = e.target.value;
                    badge.textContent = PHOTO_TYPES_BD[e.target.value];
                });
                row.querySelector('input').addEventListener('input', e => { quickFiles[idx].caption = e.target.value; });
                meta.appendChild(row);
            });
        }

        async function submitQuickUpload() {
            if (quickFiles.length === 0) { CRUDManager.showError('‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶¨‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®'); return; }
            const btn = document.getElementById('quick-upload-btn');
            const status = document.getElementById('quick-upload-status');
            btn.disabled = true;
            status.classList.remove('hidden');
            status.textContent = `${quickFiles.length}‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶`;
            try {
                const fd = new FormData();
                quickFiles.forEach(item => {
                    fd.append('images', item.file);
                    fd.append('photo_type', item.type);
                    fd.append('caption', item.caption || '');
                });
                const url = `${AuthManager.API_URL}/projects/${currentDetailId}/images`;
                const res = await AuthManager.fetch(url, { method: 'POST', body: fd });
                if (!res.ok) { const e = await res.json().catch(()=>{}); throw new Error(e?.error || '‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•'); }
                status.textContent = `${quickFiles.length}‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚úì`;
                quickFiles = [];
                renderQuickPreviews();
                setTimeout(closeQuickUpload, 1200);
                // Reload photo gallery in detail modal
                await loadProjectPhotos(currentDetailId);
                document.getElementById('dm-photos-section').classList.remove('hidden');
            } catch(e) {
                status.textContent = '‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + e.message;
            } finally {
                btn.disabled = false;
            }
        }

        // Initialise upload zones once DOM ready
        document.addEventListener('DOMContentLoaded', () => { initPhotoUpload(); initQuickUpload(); });

        // Form submit ‚Äî save project data then upload any pending photos
        document.getElementById('project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = '‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶';
            try {
                const formData = CRUDManager.formToJSON(e.target);

                // Coerce numeric & boolean fields
                formData.allocation_amount   = parseFloat(formData.allocation_amount)   || 0;
                formData.released_amount     = parseFloat(formData.released_amount)     || 0;
                formData.progress_percentage = parseInt(formData.progress_percentage)   || 0;
                formData.is_completed = formData.is_completed ? 1 : 0;
                formData.is_delayed   = formData.is_delayed   ? 1 : 0;

                // Strip empty date strings so they go as NULL
                ['start_date', 'expected_end_date', 'actual_end_date'].forEach(k => {
                    if (!formData[k]) delete formData[k];
                });

                // Normalize lat_lng: empty string ‚Üí null
                if (!formData.lat_lng || !formData.lat_lng.trim()) {
                    formData.lat_lng = null;
                } else {
                    formData.lat_lng = formData.lat_lng.trim();
                }

                let savedId = editingId;

                if (editingId) {
                    const url = `${AuthManager.API_URL}/projects/${editingId}`;
                    await AuthManager.fetch(url, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    const url = `${AuthManager.API_URL}/projects`;
                    const res = await AuthManager.fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    // New project ‚Äî use the project_id from form (used as PK)
                    savedId = formData.id || (await res.json().catch(()=>({}))).id || formData.id;
                }

                // Upload pending photos (if any) using the saved project ID
                if (pendingFiles.length > 0 && savedId) {
                    try {
                        await uploadPendingPhotos(savedId);
                    } catch (uploadErr) {
                        // Project saved OK; photo upload failed ‚Äî warn but don't rollback
                        CRUDManager.showError('‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø: ' + uploadErr.message);
                        closeFormModal();
                        await loadData();
                        return;
                    }
                }

                CRUDManager.showSuccess(editingId ? '‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá' : '‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                closeFormModal();
                await loadData();
            } catch (err) {
                CRUDManager.showError('‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®';
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LOCATION PICKER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let locationPickerMap = null;
        let locationPickerMarker = null;
        let selectedLocation = null;
        let searchTimeout = null;

        function openLocationPicker() {
            const modal = document.getElementById('location-picker-modal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Initialize map after modal is visible
            setTimeout(() => {
                initLocationPickerMap();
            }, 100);

            // Get current value if exists
            const currentValue = document.getElementById('lat-lng-input').value;
            if (currentValue && currentValue.trim()) {
                const parts = currentValue.split(',').map(s => parseFloat(s.trim()));
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    selectedLocation = { lat: parts[0], lng: parts[1], name: '‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶∏‡ßç‡¶•‡¶æ‡¶®' };
                    updateSelectedDisplay();
                    if (locationPickerMap) {
                        setMapLocation(parts[0], parts[1], '‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶∏‡ßç‡¶•‡¶æ‡¶®');
                    }
                }
            }
        }

        function closeLocationPicker() {
            const modal = document.getElementById('location-picker-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';

            // Clear search
            document.getElementById('location-search-input').value = '';
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('selected-coords-display').classList.add('hidden');
        }

        function initLocationPickerMap() {
            const container = document.getElementById('location-picker-map');

            // Default center: Kushtia, Bangladesh
            const defaultLat = 23.9012;
            const defaultLng = 89.1195;

            if (locationPickerMap) {
                locationPickerMap.remove();
                locationPickerMap = null;
                locationPickerMarker = null;
            }

            locationPickerMap = L.map(container, {
                center: [defaultLat, defaultLng],
                zoom: 13,
                zoomControl: true,
                scrollWheelZoom: true
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(locationPickerMap);

            // Click handler for map
            locationPickerMap.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                setMapLocation(lat, lng, '‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶∏‡ßç‡¶•‡¶æ‡¶®');

                // Reverse geocode to get place name
                reverseGeocode(lat, lng);
            });

            // Force resize
            setTimeout(() => {
                locationPickerMap.invalidateSize();
            }, 200);
        }

        function setMapLocation(lat, lng, name) {
            if (!locationPickerMap) return;

            selectedLocation = { lat, lng, name };
            updateSelectedDisplay();

            // Remove existing marker
            if (locationPickerMarker) {
                locationPickerMap.removeLayer(locationPickerMarker);
            }

            // Custom amber marker
            const amberIcon = L.divIcon({
                className: '',
                html: `<div style="
                    width: 40px; height: 40px;
                    background: linear-gradient(135deg, #b45309, #d97706);
                    border-radius: 50% 50% 50% 0;
                    transform: rotate(-45deg);
                    border: 3px solid #fff;
                    box-shadow: 0 4px 15px rgba(180,83,9,0.5);
                    display: flex; align-items: center; justify-content: center;
                "><svg style="transform: rotate(45deg); width: 18px; height: 18px;" fill="white" viewBox="0 0 24 24">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
                </svg></div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -42]
            });

            // Add new marker
            locationPickerMarker = L.marker([lat, lng], { icon: amberIcon })
                .addTo(locationPickerMap)
                .bindPopup(`
                    <div style="font-family: 'Hind Siliguri', sans-serif; min-width: 150px;">
                        <p style="font-weight: 700; font-size: 13px; color: #0f172a; margin: 0 0 4px;">${name}</p>
                        <p style="font-size: 10px; color: #64748b; margin: 0; font-family: monospace;">${lat.toFixed(5)}, ${lng.toFixed(5)}</p>
                    </div>
                `)
                .openPopup();

            // Center map on marker
            locationPickerMap.setView([lat, lng], 15);
        }

        function updateSelectedDisplay() {
            const display = document.getElementById('selected-coords-display');
            const coordsText = document.getElementById('selected-coords-text');
            const placeName = document.getElementById('selected-place-name');

            if (selectedLocation) {
                display.classList.remove('hidden');
                coordsText.textContent = `${selectedLocation.lat.toFixed(5)}, ${selectedLocation.lng.toFixed(5)}`;
                placeName.textContent = selectedLocation.name || '';
            } else {
                display.classList.add('hidden');
            }
        }

        function getCurrentLocation() {
            const btn = document.getElementById('current-location-btn');
            const originalText = btn.innerHTML;

            if (!navigator.geolocation) {
                CRUDManager.showError('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ Geolocation ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `
                <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...
            `;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    setMapLocation(lat, lng, '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®');
                    reverseGeocode(lat, lng);

                    btn.disabled = false;
                    btn.innerHTML = originalText;
                },
                (error) => {
                    let errorMsg = '‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•';
                    if (error.code === 1) {
                        errorMsg = '‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡¶ø‡¶®';
                    } else if (error.code === 2) {
                        errorMsg = '‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ';
                    }

                    CRUDManager.showError(errorMsg);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Search with autocomplete using Nominatim
        document.getElementById('location-search-input').addEventListener('input', function(e) {
            const query = e.target.value.trim();

            clearTimeout(searchTimeout);

            if (query.length < 3) {
                document.getElementById('search-results').innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?` +
                        `format=json&q=${encodeURIComponent(query)}&` +
                        `countrycodes=bd&limit=5&addressdetails=1`
                    );

                    const results = await response.json();
                    displaySearchResults(results);
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 500);
        });

        function displaySearchResults(results) {
            const container = document.getElementById('search-results');

            if (!results || results.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500 text-sm">
                        <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        ‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map(result => `
                <div class="search-result-item p-3 bg-white border border-gray-200 rounded-lg hover:bg-amber-50 hover:border-amber-300 cursor-pointer transition-all"
                    onclick='selectSearchResult(${result.lat}, ${result.lon}, ${JSON.stringify(result.display_name)})'>
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-800 truncate">${result.display_name}</p>
                            <p class="text-xs text-gray-500 font-mono mt-0.5">${parseFloat(result.lat).toFixed(5)}, ${parseFloat(result.lon).toFixed(5)}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectSearchResult(lat, lon, name) {
            setMapLocation(parseFloat(lat), parseFloat(lon), name);
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?` +
                    `format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                );

                const data = await response.json();
                if (data && data.display_name) {
                    selectedLocation.name = data.display_name;
                    updateSelectedDisplay();
                }
            } catch (error) {
                console.error('Reverse geocode error:', error);
            }
        }

        function applySelectedLocation() {
            if (!selectedLocation) {
                CRUDManager.showError('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
                return;
            }

            const input = document.getElementById('lat-lng-input');
            input.value = `${selectedLocation.lat.toFixed(5)},${selectedLocation.lng.toFixed(5)}`;

            // Visual feedback
            input.classList.add('ring-2', 'ring-green-500');
            setTimeout(() => {
                input.classList.remove('ring-2', 'ring-green-500');
            }, 1000);

            closeLocationPicker();
            CRUDManager.showSuccess('‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
        }

        // Close on backdrop click
        document.getElementById('location-picker-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLocationPicker();
            }
        });

        // Keyboard controls
        document.addEventListener('keydown', function(e) {
            const lightbox = document.getElementById('adm-lightbox');
            const isLightboxOpen = lightbox.classList.contains('lb-open');

            const fullMap = document.getElementById('full-map-modal');
            const isFullMapOpen = fullMap && !fullMap.classList.contains('hidden');

            if (e.key === 'Escape') {
                const modal = document.getElementById('location-picker-modal');
                if (!modal.classList.contains('hidden')) {
                    closeLocationPicker();
                }
                if (isFullMapOpen) {
                    closeFullMap();
                }
                if (isLightboxOpen) {
                    closeLightbox();
                }
            }

            // Lightbox navigation
            if (isLightboxOpen) {
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    lightboxNext();
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    lightboxPrevious();
                } else if (e.key === '+' || e.key === '=') {
                    e.preventDefault();
                    lightboxZoomIn();
                } else if (e.key === '-' || e.key === '_') {
                    e.preventDefault();
                    lightboxZoomOut();
                } else if (e.key === '0') {
                    e.preventDefault();
                    lightboxResetZoom();
                }
            }
        });

        // ‚îÄ‚îÄ Image Lightbox Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let lightboxImages = [];
        let lightboxCurrentIndex = 0;
        let lightboxZoom = 1;

        function openLightbox(imageSrc) {
            lightboxImages = allPhotos.map(p => ({
                src: `/uploads/${p.photo_path}`,
                caption: p.caption || '',
                type: PHOTO_TYPE_LABELS[p.photo_type] || p.photo_type
            }));
            lightboxCurrentIndex = lightboxImages.findIndex(img => img.src === imageSrc);
            if (lightboxCurrentIndex === -1) lightboxCurrentIndex = 0;
            document.body.style.overflow = 'hidden';
            renderLightbox();
            // Trigger open animation on next frame
            requestAnimationFrame(() => {
                document.getElementById('adm-lightbox').classList.add('lb-open');
            });
        }

        function closeLightbox() {
            document.getElementById('adm-lightbox').classList.remove('lb-open');
            document.body.style.overflow = '';
            lightboxZoom = 1;
        }

        function admLbBackdropClick(e) {
            if (e.target === document.getElementById('adm-lightbox')) closeLightbox();
        }

        function renderLightbox() {
            if (lightboxImages.length === 0) return;
            const img     = document.getElementById('adm-lb-img');
            const caption = document.getElementById('lightbox-caption');
            const counter = document.getElementById('lightbox-counter');
            const current = lightboxImages[lightboxCurrentIndex];

            img.src = current.src;
            img.style.transform = `scale(${lightboxZoom})`;

            caption.innerHTML = current.caption
                ? `<span class="adm-lb-type-pill">${current.type}</span><br><span>${current.caption}</span>`
                : `<span class="adm-lb-type-pill">${current.type}</span>`;

            counter.textContent = `${lightboxCurrentIndex + 1} / ${lightboxImages.length}`;
            document.getElementById('lightbox-zoom-level').textContent = `${Math.round(lightboxZoom * 100)}%`;

            renderLightboxThumbnails();

            const multi = lightboxImages.length > 1;
            document.getElementById('lightbox-prev').classList.toggle('lb-hidden', !multi);
            document.getElementById('lightbox-next').classList.toggle('lb-hidden', !multi);
        }

        function renderLightboxThumbnails() {
            const container = document.getElementById('lightbox-thumbnails');
            container.innerHTML = '';
            lightboxImages.forEach((image, idx) => {
                const thumb = document.createElement('div');
                thumb.className = 'adm-lb-thumb' + (idx === lightboxCurrentIndex ? ' active' : '');
                thumb.onclick = () => { lightboxCurrentIndex = idx; lightboxZoom = 1; renderLightbox(); };
                const t = document.createElement('img');
                t.src = image.src;
                thumb.appendChild(t);
                container.appendChild(thumb);
            });
        }

        function lightboxNext() {
            if (lightboxImages.length === 0) return;
            lightboxCurrentIndex = (lightboxCurrentIndex + 1) % lightboxImages.length;
            lightboxZoom = 1;
            renderLightbox();
        }

        function lightboxPrevious() {
            if (lightboxImages.length === 0) return;
            lightboxCurrentIndex = (lightboxCurrentIndex - 1 + lightboxImages.length) % lightboxImages.length;
            lightboxZoom = 1;
            renderLightbox();
        }

        function lightboxZoomIn() {
            lightboxZoom = Math.min(lightboxZoom + 0.25, 3);
            renderLightbox();
        }

        function lightboxZoomOut() {
            lightboxZoom = Math.max(lightboxZoom - 0.25, 0.5);
            renderLightbox();
        }

        function lightboxResetZoom() {
            lightboxZoom = 1;
            renderLightbox();
        }

        // ‚îÄ‚îÄ Full Screen Map Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let fullMapInstance = null;
        let fullMapMarker = null;
        let currentProjectData = null;

        function openFullMap() {
            if (!currentProjectData || !currentProjectData.lat_lng) {
                alert('‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø');
                return;
            }

            const modal = document.getElementById('full-map-modal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Parse coordinates
            const [lat, lng] = currentProjectData.lat_lng.split(',').map(s => parseFloat(s.trim()));

            // Update modal info
            document.getElementById('full-map-title').textContent = currentProjectData.project_name || '‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®';
            document.getElementById('full-map-coords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('full-map-project-name').textContent = currentProjectData.project_name || '';
            document.getElementById('full-map-google-link').href = `https://www.google.com/maps?q=${lat},${lng}`;

            // Initialize map after a short delay to ensure container is rendered
            setTimeout(() => {
                initFullMap(lat, lng, currentProjectData.project_name);
            }, 100);
        }

        function initFullMap(lat, lng, projectName) {
            const container = document.getElementById('full-map-container');

            // Remove existing map if any
            if (fullMapInstance) {
                fullMapInstance.remove();
                fullMapInstance = null;
            }

            // Create new map
            fullMapInstance = L.map(container, {
                center: [lat, lng],
                zoom: 15,
                zoomControl: true,
                scrollWheelZoom: true
            });

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(fullMapInstance);

            // Add marker
            const customIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            fullMapMarker = L.marker([lat, lng], { icon: customIcon }).addTo(fullMapInstance);
            fullMapMarker.bindPopup(`<strong>${projectName || '‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®'}</strong><br>${lat.toFixed(6)}, ${lng.toFixed(6)}`).openPopup();

            // Force map to redraw
            setTimeout(() => {
                fullMapInstance.invalidateSize();
            }, 200);
        }

        function closeFullMap() {
            const modal = document.getElementById('full-map-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';

            // Clean up map
            if (fullMapInstance) {
                fullMapInstance.remove();
                fullMapInstance = null;
            }
        }

        // Store current project data when detail modal opens
        const originalShowDetailModal = showDetailModal;
        showDetailModal = function(r) {
            currentProjectData = r;
            originalShowDetailModal(r);
        };

        // ‚îÄ‚îÄ Edit Project Location ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function editProjectLocation() {
            if (!currentProjectData) {
                alert('‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ');
                return;
            }

            // Store the current location for the location picker
            const currentLatLng = currentProjectData.lat_lng || '';

            // Set the input value
            const input = document.getElementById('lat-lng-input');
            if (input) {
                input.value = currentLatLng;
            }

            // Open location picker
            openLocationPicker();

            // Override the applySelectedLocation function temporarily
            const originalApply = window.applySelectedLocation;
            window.applySelectedLocation = async function() {
                const newLatLng = document.getElementById('lat-lng-input').value.trim();

                if (!newLatLng) {
                    alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
                    return;
                }

                try {
                    // Update project location via API
                    const response = await AuthManager.fetch(
                        `${AuthManager.API_URL}/projects/${currentProjectData.id}`,
                        {
                            method: 'PUT',
                            body: JSON.stringify({ lat_lng: newLatLng })
                        }
                    );

                    if (!response.ok) {
                        throw new Error('‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
                    }

                    // Update current project data
                    currentProjectData.lat_lng = newLatLng;

                    // Close location picker
                    closeLocationPicker();

                    // Reload the detail modal to show updated map
                    showDetailModal(currentProjectData);

                    // Show success message
                    alert('‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚úì');

                    // Restore original function
                    window.applySelectedLocation = originalApply;

                } catch (error) {
                    console.error('Location update error:', error);
                    alert('‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + error.message);
                }
            };
        }
    </script>
</body>
</html>
